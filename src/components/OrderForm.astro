---
const {
  product_id = '',
  product_name = 'Produk',
  price = 0,
  currency = 'IDR',
  quantity = 1
} = Astro.props;
---

<div class="max-w-md mx-auto p-6 bg-white rounded-lg shadow-lg">
  <h2 class="text-2xl font-bold mb-6 text-center">Form Pemesanan</h2>
  
  <form id="orderForm" class="space-y-4">
    <!-- Honeypot field (hidden) -->
    <input type="text" name="website" class="hidden" tabindex="-1" autocomplete="off" />
    
    <div>
      <label for="nama" class="block text-sm font-medium text-gray-700 mb-1">
        Nama Lengkap <span class="text-red-500">*</span>
      </label>
      <input
        type="text"
        id="nama"
        name="nama"
        required
        minlength="3"
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        placeholder="Masukkan nama lengkap"
      />
    </div>

    <div>
      <label for="whatsapp" class="block text-sm font-medium text-gray-700 mb-1">
        Nomor WhatsApp <span class="text-red-500">*</span>
      </label>
      <input
        type="tel"
        id="whatsapp"
        name="whatsapp"
        required
        pattern="[0-9]+"
        minlength="10"
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        placeholder="08123456789"
      />
      <p class="mt-1 text-xs text-gray-500">Format: 08xxx atau 628xxx</p>
    </div>

    <div class="pt-2">
      <button
        type="submit"
        id="submitBtn"
        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 ease-in-out transform hover:scale-105"
      >
        Beli Sekarang ¬ª
      </button>
    </div>

    <div id="message" class="text-center"></div>
  </form>
</div>

<script define:vars={{ product_id, product_name, price, currency, quantity }}>
  document.addEventListener('DOMContentLoaded', () => {
    const formEl = document.getElementById('orderForm');
    const btnEl = document.getElementById('submitBtn');
    const msgEl = document.getElementById('message');

    // Environment variables
    const USE_PROD = import.meta.env.PUBLIC_USE_PROD === 'true';
    const WEBHOOK_URL = USE_PROD 
      ? import.meta.env.PUBLIC_WEBHOOK_PROD 
      : import.meta.env.PUBLIC_WEBHOOK_TEST;
    const PIXEL_ID = import.meta.env.PUBLIC_PIXEL_ID;
    const EVENT_NAME = import.meta.env.PUBLIC_EVENT_NAME || 'AddToCart';
    const WA_NUMBER = import.meta.env.PUBLIC_WA_NUMBER;
    const WA_NEW_TAB = import.meta.env.PUBLIC_WA_NEW_TAB === 'true';

    // Helper: Get cookie
    function getCookie(name) {
      const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
      return match ? match[2] : null;
    }

    // Helper: Set cookie
    function setCookie(name, value, days = 90) {
      const expires = new Date(Date.now() + days * 864e5).toUTCString();
      document.cookie = `${name}=${value}; expires=${expires}; path=/; SameSite=Lax`;
    }

    // Helper: Generate event ID
    function makeEventId() {
      return Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    }

    // Helper: Get UTM parameters
    function getUTMs() {
      const params = new URLSearchParams(location.search);
      return {
        utm_source: params.get('utm_source') || '',
        utm_medium: params.get('utm_medium') || '',
        utm_campaign: params.get('utm_campaign') || '',
        utm_term: params.get('utm_term') || '',
        utm_content: params.get('utm_content') || ''
      };
    }

    // Helper: Normalize WhatsApp number
    function normalizeWA(input) {
      let digits = input.replace(/\D/g, '');
      if (digits.startsWith('0')) digits = '62' + digits.slice(1);
      else if (!digits.startsWith('62')) digits = '62' + digits;
      return digits;
    }

    formEl.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      btnEl.disabled = true;
      btnEl.textContent = 'Mengirim...';
      msgEl.textContent = '';

      const formData = new FormData(formEl);
      const honeypot = formData.get('website');
      const nama = (formData.get('nama') || '').trim();
      const whatsapp = (formData.get('whatsapp') || '').trim();

      const okNama = nama.length >= 3;
      const okWa = whatsapp.length >= 10;
      const waDigits = normalizeWA(whatsapp);

      // Spam check
      if (honeypot) {
        msgEl.textContent = 'Terdeteksi spam.';
        msgEl.className = 'mt-3 text-red-700';
        btnEl.disabled = false;
        btnEl.textContent = 'Beli Sekarang ¬ª';
        return;
      }

      // Validation
      if (!okNama || !okWa) {
        msgEl.textContent = 'Periksa kembali data yang diisi.';
        msgEl.className = 'mt-3 text-red-700';
        formEl.reportValidity();
        btnEl.disabled = false;
        btnEl.textContent = 'Beli Sekarang ¬ª';
        return;
      }

      // Facebook Pixel cookies
      const fbp = getCookie('_fbp') || '';
      let fbc = getCookie('_fbc') || '';
      const fbclid = new URLSearchParams(location.search).get('fbclid');
      
      if (!fbc && fbclid) {
        fbc = `fb.1.${Date.now()}.${fbclid}`;
        setCookie('_fbc', fbc);
      }

      const event_id = makeEventId();

      // Facebook Pixel: Advanced Matching
      try {
        if (window.fbq && PIXEL_ID) {
          const first = (nama || '').toLowerCase().split(' ')[0] || '';
          const last = (nama || '').toLowerCase().split(' ').slice(1).join(' ') || '';
          fbq('init', PIXEL_ID, { 
            ph: waDigits, 
            fn: first, 
            ln: last, 
            country: 'id' 
          });
        }
      } catch (err) {
        console.error('[PIXEL] AM Error', err);
      }

      // Facebook Pixel: Track Event
      try {
        if (window.fbq) {
          fbq('track', EVENT_NAME, {
            value: price,
            currency,
            contents: [{ id: product_id || 'SKU', quantity, item_price: price }],
            content_type: 'product',
            content_name: product_name || 'Produk',
            status: 'submitted'
          }, { eventID: event_id });
        }
      } catch (err) {
        console.error('[PIXEL] Track Error', err);
      }

      // Webhook payload
      const payload = {
        event_name: EVENT_NAME,
        event_id,
        fbp,
        fbc,
        url: location.href,
        utm: getUTMs(),
        user_agent: navigator.userAgent,
        ts: new Date().toISOString(),
        form: {
          nama,
          whatsapp: waDigits,
          product_id,
          product_name,
          price,
          currency,
          quantity
        }
      };

      try {
        // Send to webhook
        const res = await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          credentials: 'omit'
        });

        const text = await res.text();

        if (!res.ok) {
          throw new Error('Bad response ' + res.status + ' ‚Äî ' + text);
        }

        msgEl.textContent = (USE_PROD ? '‚úÖ Terkirim' : '‚úÖ Terkirim (TEST)') + ' ‚Äî membuka WhatsApp...';
        msgEl.className = 'mt-3 text-green-700';

        // Redirect to WhatsApp
        const waText = `Halo, saya sudah melakukan pemesanan ${product_name || "Produk"}, atas nama ${nama}. Mohon segera diproses ya üôèüèª`;
        const waUrl = `https://api.whatsapp.com/send?phone=${WA_NUMBER}&text=${encodeURIComponent(waText)}`;

        WA_NEW_TAB ? window.open(waUrl, '_blank') : (window.location.href = waUrl);

      } catch (err) {
        console.error('[WEBHOOK] Error', err);
        msgEl.textContent = '‚ö†Ô∏è Gagal kirim. Error Network.';
        msgEl.className = 'mt-3 text-red-700';
      } finally {
        btnEl.disabled = false;
        btnEl.textContent = 'Beli Sekarang ¬ª';
      }
    });
  });
</script>
